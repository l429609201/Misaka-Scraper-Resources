name: Sync to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # Job 1: 同步代码和 tags
  sync-code:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to Gitee
        run: |
          git remote add gitee https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ secrets.GITEE_USERNAME }}/Misaka-Scraper-Resources.git
          git push gitee --all --force
          git push gitee --tags --force

  # Job 2: 获取最新 release 信息
  get-latest-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      name: ${{ steps.get-tag.outputs.name }}
    steps:
      - name: Get latest release tag
        id: get-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT
          else
            # 手动触发，获取最新的 release
            LATEST=$(gh release list --limit 1 --json tagName,name | jq -r '.[0]')
            TAG=$(echo $LATEST | jq -r '.tagName')
            NAME=$(echo $LATEST | jq -r '.name')
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "name=$NAME" >> $GITHUB_OUTPUT
          fi

  # Job 3: 下载资产并创建 Gitee Release
  create-release:
    needs: [sync-code, get-latest-release]
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create.outputs.release_id }}
      files: ${{ steps.list-files.outputs.files }}
    steps:
      - name: Download assets from GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-latest-release.outputs.tag }}"
          echo "Downloading assets for: $TAG"
          mkdir -p ./release-assets
          gh release download "$TAG" -D ./release-assets || true
          ls -la ./release-assets/

      - name: Create Gitee Release
        id: create
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
        run: |
          TAG="${{ needs.get-latest-release.outputs.tag }}"
          NAME="${{ needs.get-latest-release.outputs.name }}"
          
          # 检查是否已存在
          EXISTING=$(curl -s "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/Misaka-Scraper-Resources/releases/tags/${TAG}?access_token=${GITEE_TOKEN}" | jq -r '.id // empty')
          
          if [ -n "$EXISTING" ]; then
            echo "Release $TAG already exists, ID: $EXISTING"
            echo "release_id=$EXISTING" >> $GITHUB_OUTPUT
          else
            RESPONSE=$(curl -s -X POST \
              "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/Misaka-Scraper-Resources/releases" \
              -H "Content-Type: application/json" \
              -d "{
                \"access_token\": \"${GITEE_TOKEN}\",
                \"tag_name\": \"${TAG}\",
                \"name\": \"${NAME}\",
                \"body\": \"Synced from GitHub\",
                \"target_commitish\": \"main\"
              }")
            
            RELEASE_ID=$(echo $RESPONSE | jq -r '.id')
            echo "Created release ID: $RELEASE_ID"
            echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          fi

      - name: List files for matrix
        id: list-files
        run: |
          FILES=$(ls -1 ./release-assets 2>/dev/null | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Files to upload: $FILES"

      - name: Upload assets cache
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: ./release-assets/
          retention-days: 1

  # Job 4: 并行上传文件
  upload-files:
    needs: [create-release]
    if: needs.create-release.outputs.release_id != 'null' && needs.create-release.outputs.files != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.create-release.outputs.files) }}
      max-parallel: 10
      fail-fast: false
    steps:
      - name: Download assets cache
        uses: actions/download-artifact@v4
        with:
          name: release-assets
          path: ./release-assets/

      - name: Upload ${{ matrix.file }}
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
        run: |
          FILE="./release-assets/${{ matrix.file }}"
          RELEASE_ID="${{ needs.create-release.outputs.release_id }}"
          
          echo "Uploading: ${{ matrix.file }}"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/Misaka-Scraper-Resources/releases/${RELEASE_ID}/attach_files" \
            -F "access_token=${GITEE_TOKEN}" \
            -F "file=@$FILE")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✓ Uploaded: ${{ matrix.file }}"
          else
            echo "✗ Failed: ${{ matrix.file }} (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

  # Job 5: 汇总
  summary:
    needs: [sync-code, get-latest-release, create-release, upload-files]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.get-latest-release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release ID**: ${{ needs.create-release.outputs.release_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| sync-code | ${{ needs.sync-code.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| create-release | ${{ needs.create-release.outputs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| upload-files | ${{ needs.upload-files.result }} |" >> $GITHUB_STEP_SUMMARY
