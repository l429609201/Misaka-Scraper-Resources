name: Sync to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push Code and Tags to Gitee
        run: |
          git remote add gitee https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ secrets.GITEE_USERNAME }}/Misaka-Scraper-Resources.git
          git push gitee --all --force
          git push gitee --tags --force

      - name: Sync Single Release (on publish)
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          NAME="${{ github.event.release.name }}"
          
          echo "Syncing release: $TAG"
          
          mkdir -p ./release-assets
          gh release download "$TAG" -D ./release-assets || true
          
          RESPONSE=$(curl -s -X POST \
            "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/Misaka-Scraper-Resources/releases" \
            -H "Content-Type: application/json" \
            -d "{
              \"access_token\": \"${GITEE_TOKEN}\",
              \"tag_name\": \"${TAG}\",
              \"name\": \"${NAME:-$TAG}\",
              \"body\": \"Synced from GitHub\",
              \"target_commitish\": \"main\"
            }")
          
          RELEASE_ID=$(echo $RESPONSE | jq -r '.id')
          echo "Created release ID: $RELEASE_ID"
          
          if [ "$RELEASE_ID" != "null" ] && [ -d "./release-assets" ] && [ "$(ls -A ./release-assets 2>/dev/null)" ]; then
            for file in ./release-assets/*; do
              [ -f "$file" ] || continue
              echo "Uploading: $(basename $file)"
              curl -s -X POST \
                "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/Misaka-Scraper-Resources/releases/${RELEASE_ID}/attach_files" \
                -F "access_token=${GITEE_TOKEN}" \
                -F "file=@$file"
            done
          fi

      - name: Sync All Releases (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
        run: |
          echo "Fetching all GitHub releases..."
          
          # 获取已存在的 Gitee releases
          echo "Fetching existing Gitee releases..."
          GITEE_RELEASES=$(curl -s "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/Misaka-Scraper-Resources/releases?access_token=${GITEE_TOKEN}&per_page=100")
          GITEE_TAGS=$(echo $GITEE_RELEASES | jq -r '.[].tag_name' 2>/dev/null || echo "")
          
          # 获取 GitHub releases 列表（只取 tagName 和 name）
          gh release list --limit 100 --json tagName,name | jq -c '.[]' | while read release; do
            TAG=$(echo $release | jq -r '.tagName')
            NAME=$(echo $release | jq -r '.name')
            
            # 检查是否已存在
            if echo "$GITEE_TAGS" | grep -q "^${TAG}$"; then
              echo "Skip: $TAG (already exists on Gitee)"
              continue
            fi
            
            echo "========================================"
            echo "Syncing: $TAG"
            
            # 下载资产
            rm -rf ./release-assets
            mkdir -p ./release-assets
            gh release download "$TAG" -D ./release-assets || true
            
            # 创建 Release
            RESPONSE=$(curl -s -X POST \
              "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/Misaka-Scraper-Resources/releases" \
              -H "Content-Type: application/json" \
              -d "{
                \"access_token\": \"${GITEE_TOKEN}\",
                \"tag_name\": \"${TAG}\",
                \"name\": \"${NAME:-$TAG}\",
                \"body\": \"Synced from GitHub\",
                \"target_commitish\": \"main\"
              }")
            
            RELEASE_ID=$(echo $RESPONSE | jq -r '.id')
            echo "Created release ID: $RELEASE_ID"
            
            # 上传资产
            if [ "$RELEASE_ID" != "null" ] && [ -d "./release-assets" ] && [ "$(ls -A ./release-assets 2>/dev/null)" ]; then
              for file in ./release-assets/*; do
                [ -f "$file" ] || continue
                echo "  Uploading: $(basename $file)"
                curl -s -X POST \
                  "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/Misaka-Scraper-Resources/releases/${RELEASE_ID}/attach_files" \
                  -F "access_token=${GITEE_TOKEN}" \
                  -F "file=@$file"
              done
            fi
            
            echo "Done: $TAG"
            sleep 1
          done
          
          echo "========================================"
          echo "All releases synced!"
