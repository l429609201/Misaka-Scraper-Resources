name: Sync to Gitee

on:
  push:
    branches: [main, test]
  release:
    types: [published]
  workflow_dispatch:

env:
  GITHUB_REPO: l429609201/Misaka-Scraper-Resources
  GITEE_REPO: Misaka-Scraper-Resources

jobs:
  # Job 1: 同步代码
  sync-code:
    runs-on: ubuntu-latest
    steps:
      - name: Sync GitHub to Gitee
        run: |
          GITEE_URL="https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ secrets.GITEE_USERNAME }}/${{ env.GITEE_REPO }}.git"

          # 克隆 GitHub 仓库（非 mirror，避免 refs 锁冲突）
          git clone --bare https://github.com/${{ env.GITHUB_REPO }}.git repo
          cd repo

          echo "=== GitHub Branches ==="
          git branch -a
          echo "=== GitHub Tags ==="
          git tag -l

          # 添加 Gitee 远程
          git remote add gitee "$GITEE_URL"

          # 逐个分支强制推送（避免 --mirror 的 refs 锁问题）
          echo "=== Pushing branches ==="
          for branch in $(git branch | sed 's/\* //'); do
            echo "Pushing branch: $branch"
            git push gitee "refs/heads/$branch:refs/heads/$branch" --force 2>&1 || echo "Warning: failed to push branch $branch"
          done

          # 逐个 tag 强制推送
          echo "=== Pushing tags ==="
          for tag in $(git tag -l); do
            echo "Pushing tag: $tag"
            git push gitee "refs/tags/$tag:refs/tags/$tag" --force 2>&1 || echo "Warning: failed to push tag $tag"
          done

          echo "=== Sync completed ==="

  # Job 2: 获取最新 release 信息（仅 main 分支）
  get-latest-release:
    if: github.ref_name == 'main'
    needs: [sync-code]
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      name: ${{ steps.get-tag.outputs.name }}
    steps:
      - name: Get latest release tag
        id: get-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            NAME="${{ github.event.release.name }}"
          else
            LATEST=$(gh release list --repo ${{ env.GITHUB_REPO }} --limit 1 --json tagName,name | jq -r '.[0]')
            TAG=$(echo $LATEST | jq -r '.tagName')
            NAME=$(echo $LATEST | jq -r '.name')
          fi
          echo "Tag: $TAG, Name: $NAME"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

  # Job 3: 下载资产并获取文件列表（仅 main 分支）
  download-assets:
    if: github.ref_name == 'main'
    needs: [get-latest-release]
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.list-files.outputs.files }}
      has_files: ${{ steps.list-files.outputs.has_files }}
    steps:
      - name: Download assets from GitHub
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.get-latest-release.outputs.tag }}"
          echo "Downloading assets for tag: $TAG from repo: ${{ env.GITHUB_REPO }}"
          mkdir -p ./release-assets
          
          gh release download "$TAG" --repo ${{ env.GITHUB_REPO }} -D ./release-assets 2>&1 || echo "Download completed"
          
          echo "Downloaded files:"
          ls -la ./release-assets/

      - name: List files for matrix
        id: list-files
        run: |
          if [ -d "./release-assets" ] && [ "$(ls -A ./release-assets 2>/dev/null)" ]; then
            FILES=$(ls -1 ./release-assets | jq -R -s -c 'split("\n") | map(select(length > 0))')
            COUNT=$(echo $FILES | jq 'length')
            echo "Found $COUNT files: $FILES"
            echo "files=$FILES" >> $GITHUB_OUTPUT
            echo "has_files=true" >> $GITHUB_OUTPUT
          else
            echo "No files found"
            echo "files=[]" >> $GITHUB_OUTPUT
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload assets cache
        if: steps.list-files.outputs.has_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: ./release-assets/*
          retention-days: 1

  # Job 4: 创建 Gitee Release（仅 main 分支）
  create-gitee-release:
    if: github.ref_name == 'main'
    needs: [sync-code, get-latest-release, download-assets]
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create.outputs.release_id }}
    steps:
      - name: Create Gitee Release
        id: create
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
        run: |
          TAG="${{ needs.get-latest-release.outputs.tag }}"
          NAME="${{ needs.get-latest-release.outputs.name }}"
          
          echo "Creating Gitee release: $TAG"
          
          # 检查是否已存在
          EXISTING=$(curl -s "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/${{ env.GITEE_REPO }}/releases/tags/${TAG}?access_token=${GITEE_TOKEN}")
          EXISTING_ID=$(echo $EXISTING | jq -r '.id // empty')
          
          if [ -n "$EXISTING_ID" ] && [ "$EXISTING_ID" != "null" ]; then
            echo "Release already exists, ID: $EXISTING_ID"
            echo "release_id=$EXISTING_ID" >> $GITHUB_OUTPUT
          else
            RESPONSE=$(curl -s -X POST \
              "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/${{ env.GITEE_REPO }}/releases" \
              -H "Content-Type: application/json" \
              -d "{
                \"access_token\": \"${GITEE_TOKEN}\",
                \"tag_name\": \"${TAG}\",
                \"name\": \"${NAME}\",
                \"body\": \"Synced from GitHub\",
                \"target_commitish\": \"main\"
              }")

            RELEASE_ID=$(echo $RESPONSE | jq -r '.id')
            echo "Created release ID: $RELEASE_ID"
            echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          fi

  # Job 5: 并行上传文件（仅 main 分支）
  upload-files:
    if: github.ref_name == 'main' && needs.download-assets.outputs.has_files == 'true'
    needs: [download-assets, create-gitee-release]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.download-assets.outputs.files) }}
      max-parallel: 10
      fail-fast: false
    steps:
      - name: Download assets cache
        uses: actions/download-artifact@v4
        with:
          name: release-assets
          path: ./release-assets/

      - name: Upload ${{ matrix.file }}
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME }}
        run: |
          FILE="./release-assets/${{ matrix.file }}"
          RELEASE_ID="${{ needs.create-gitee-release.outputs.release_id }}"

          echo "Uploading: ${{ matrix.file }} to release $RELEASE_ID"
          ls -la ./release-assets/

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://gitee.com/api/v5/repos/${GITEE_USERNAME}/${{ env.GITEE_REPO }}/releases/${RELEASE_ID}/attach_files" \
            -F "access_token=${GITEE_TOKEN}" \
            -F "file=@$FILE")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✓ Uploaded: ${{ matrix.file }}"
          else
            echo "✗ Failed: ${{ matrix.file }} (HTTP $HTTP_CODE)"
            echo "$RESPONSE"
            exit 1
          fi

  # Job 6: 汇总（仅 main 分支）
  summary:
    if: github.ref_name == 'main' && always()
    needs: [get-latest-release, create-gitee-release, upload-files]
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ needs.get-latest-release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Gitee Release ID**: ${{ needs.create-gitee-release.outputs.release_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Upload Status**: ${{ needs.upload-files.result }}" >> $GITHUB_STEP_SUMMARY

